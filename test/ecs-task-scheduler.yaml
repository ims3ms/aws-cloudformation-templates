AWSTemplateFormatVersion: '2010-09-09'
Description: ECS Fargate Task Scheduler with EventBridge, VPC, SG, Roles

Resources:

  ECSVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
      - Key: Name
        Value: ecs-fargate-vpc

  ECSInternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
      - Key: Name
        Value: ecs-fargate-igw

  AttachIGW:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref ECSVPC
      InternetGatewayId: !Ref ECSInternetGateway

  ECSRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref ECSVPC
      Tags:
      - Key: Name
        Value: ecs-fargate-rt

  ECSDefaultRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachIGW
    Properties:
      RouteTableId: !Ref ECSRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref ECSInternetGateway

  ECSSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref ECSVPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [ 0, !GetAZs '' ]
      MapPublicIpOnLaunch: true
      Tags:
      - Key: Name
        Value: ecs-fargate-subnet1

  ECSSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref ECSVPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select [ 1, !GetAZs '' ]
      MapPublicIpOnLaunch: true
      Tags:
      - Key: Name
        Value: ecs-fargate-subnet2

  ECSSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref ECSSubnet1
      RouteTableId: !Ref ECSRouteTable

  ECSSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref ECSSubnet2
      RouteTableId: !Ref ECSRouteTable

  ECSFargateSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: ECS Fargate security group
      VpcId: !Ref ECSVPC
      SecurityGroupIngress: []
      SecurityGroupEgress:
      - IpProtocol: "-1"
        CidrIp: 0.0.0.0/0
      Tags:
      - Key: Name
        Value: ecs-fargate-sg

  ECSCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: ecs-fargate-cluster

  ECSTaskExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: CustomECSTaskExecutionRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: ecs-tasks.amazonaws.com
          Action: sts:AssumeRole
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy

  EventBridgeRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: CustomEventBridgeECSRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: events.amazonaws.com
          Action: sts:AssumeRole
      Policies:
      - PolicyName: EventBridgeRunECSTaskPolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - ecs:RunTask
            - ecs:StopTask
            - ecs:DescribeTasks
            - iam:PassRole
            Resource: "*"

  ECSTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: ecs-fargate-task
      Cpu: 256
      Memory: 512
      NetworkMode: awsvpc
      RequiresCompatibilities:
      - FARGATE
      ExecutionRoleArn: !GetAtt ECSTaskExecutionRole.Arn
      ContainerDefinitions:
      - Name: sample-container
        Image: public.ecr.aws/nginx/nginx:latest
        Essential: true
        PortMappings:
        - ContainerPort: 80
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: /ecs/fargate-task-logs
            awslogs-region: !Ref "AWS::Region"
            awslogs-stream-prefix: ecs

  ECSLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /ecs/fargate-task-logs
      RetentionInDays: 7

  ECSFargateScheduleRule:
    Type: AWS::Events::Rule
    Properties:
      Name: ecs-fargate-schedule-rule
      ScheduleExpression: cron(0/15 * * * ? *)
      State: ENABLED
      Targets:
      - Arn: !GetAtt ECSCluster.Arn
        Id: ecs-fargate-target
        RoleArn: !GetAtt EventBridgeRole.Arn
        EcsParameters:
          TaskDefinitionArn: !Ref ECSTaskDefinition
          LaunchType: FARGATE
          NetworkConfiguration:
            AwsVpcConfiguration:
              Subnets:
              - !Ref ECSSubnet1
              - !Ref ECSSubnet2
              SecurityGroups:
              - !Ref ECSFargateSG
              AssignPublicIp: ENABLED
          TaskCount: 1

Outputs:
  ECSClusterName:
    Description: ECS Cluster Name
    Value: !Ref ECSCluster

  ECSTaskDefinition:
    Description: ECS Task Definition ARN
    Value: !Ref ECSTaskDefinition
